---
title: "Preprocesado de datos del Fifa 2017"
author: "Jesús González"
date: "25/3/2021"
output:
  html_document:
    toc: yes
    toc_float: yes
    toc_depth: 2
    number_sections: no
    theme: paper
    highlight: default
  pdf_document:
    
    toc: yes
    toc_depth: '2'
    highlight: zenburn
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#install.packages("tidyverse")
#library(tidyverse)
library(stringr)
library(dplyr)
library(lubridate)
library(ggplot2)

# Winsor package
# https://www.rdocumentation.org/packages/psych/versions/2.0.12/topics/winsor
# install.packages('psych')
library(psych)

# ggbiplot package
# https://www.rdocumentation.org/packages/ggbiplot/versions/0.55
# https://www.rdocumentation.org/packages/ggbiplot/versions/0.55/topics/ggbiplot
library(devtools)
#install_github("vqv/ggbiplot")
library(ggbiplot)

```

# Introducción

Esta actividad se centra en la etapa de preprocesado necesario para preparar los datos para su posterior análisis. Para ello, se detectan y se corrigen posibles errores, inconsistencias y valores perdidos. Se presenta, además, una breve estadística descriptiva y se realizará un análisis de componentes principales (PCA) con algunas de las variables cuantitativas.

El fichero de datos utilizado contiene el estilo de juego del videojuego de consola Fifa 2017, así como estadísticas reales de los jugadores de fútbol. El conjunto de datos está formado por algo más de 17500 registros y 53 variables, de las cuales se han escogido una selección para este trabajo.

# 1. Carga del archivo

```{r}
fifa.df <- read.csv(file="fifa_raw.csv", encoding = "UTF-8")
paste0("Número de observaciones: ", nrow(fifa.df),". Número de variables: ", ncol(fifa.df))
```

Realizamos un subset con las variables escogidas para el estudio.

```{r}
col_names <- c("ID", "Name", "Nationality", "Club_Joining", "Contract_Expiry", "Rating", "Height", "Weight", "Preffered_Foot", "Birth_Date", "Age", "Work_Rate")
fifa.df.sub <- fifa.df[, col_names]
paste0("Número de observaciones: ", nrow(fifa.df.sub),". Número de variables: ", ncol(fifa.df.sub))
```

Se ha pasado de 54 variables a 12, manteniendo el número de observaciones. A continuación se muestran las 5 primeras observaciones de la muestra.

```{r message=TRUE}
head(fifa.df.sub,5)
```

Vamos a examinar cada una de las variables.

```{r}
summary(fifa.df.sub)
```

De la observación de las características de las variables y de las cinco primera observaciones podemos ver lo siguiente:

1.  **Contract_Expiry**: Presenta como mínimo un valor NA.

2.  **Preffered_Foot**: Contiene valores 1,2 que se tendrán que traducir en Left y Right respectivamente.

3.  En las variables numéricas, a excepción de la anterior en la que carece de sentido, la media y la mediana tienen valores similares. Ésto indica que los valores extremos de la serie no tienen un gran impacto sobre la misma, al no mover la media de su posición central.

4.  Las variables **Height** y **Weight** presentan valores NA que tendrán que ser tratados con posterioridad. Además el tipo de estas variables es literal, por lo que tendrán que ser tratadas para su conversión a numéricas enteras.

# 2. Verificar la duplicación de registros

En esta sección se realizará la comprobación de existencia de observaciones duplicadas en la muestra. Para ello, primeramente vamos a comprobar si existen valores duplicados en el campo *"ID"*, mediante la comparación de la longitud del vector antes y después de aplicar la función de eliminación de duplicados.

```{r}
if (length(fifa.df.sub$ID) == length(unique(fifa.df.sub$ID))) {
  print("No hay diferencias en el ID")} else {print("Existen diferencias en el ID")}
```

No obstante, esto no nos garantiza que no existan jugadores duplicados, dado que el ID puede ser generado con un autonumérico en Base de Datos. Como doble comprobación, utilizaremos la variable con el nombre del jugador, como criterio extra en la búsqueda de duplicados.

```{r}
if (length(unique(fifa.df.sub$Name)) != nrow(fifa.df.sub)){
  paste("Tenemos", (nrow(fifa.df.sub) - length(unique(fifa.df.sub$Name))), 
        "posibles registros duplicados.")
}
```

Vamos a mostrar algunos de los duplicados.

```{r}
head(fifa.df.sub[duplicated(fifa.df.sub$Name),], 5)

```

Si escogemos uno aleatóriamente, por ejemplo el jugador "Fernando".

```{r}
fifa.df.sub[fifa.df.sub$Name == "Fernando",]
```

Podemos ver comparando el resto de variables que muestra a tres jugadores diferentes. **Como es lógico pensar** que Fernando es un nombre común, vamos a probar con otro como "Lisandro López".

```{r}
fifa.df.sub[fifa.df.sub$Name == "Lisandro López",]
```

Viendo por el resultado, que también estamos hablando de dos jugadores con variables diferentes.

Tras lo visto, y viendo que la calidad del dato es bastante pobre, [no podemos confirmar que existan observaciones duplicadas en la muestra]{.ul}.

# 3. Normalización de los datos cuantitativos

En este apartado se va a realizar la normalización de la variables cuantitativas con objeto de uniformizar su formato.

## 3.1 Rating

La variable numérica *rating*, incluye la valoración del jugador dentro de un rango entre 0 y 100. Un vistazo a sus valores máximos y mínimo nos puede mostrar si están dentro del rango esperado.

```{r}
str(fifa.df.sub$Rating)
summary(fifa.df.sub$Rating)[c(1,6)]
```

Viendo que [todos sus valores se encuentran dentro del intervalo correcto]{.ul}.

## 3.2 Height

La variable que muestra la altura de los jugadores, *height*, debe de estar en cm **con un formato de 3 dígitos sin decimales**. Vamos a explorar como viene el dato en esta variable.

```{r}
head(fifa.df.sub$Height,20)
```

Además, tenemos que tener especial cuidado debido a que las medidas en metros, no cumplen con una homegeneidad de formato, como se puede ver en el siguiente registro

```{r}
fifa.df[29,c("Name", "Height")]
```

Vemos que hay observaciones con medidas en **centímetros**, y otras en **metros**. Eliminaremos la unidad que aparece al final

```{r}
fifa.df.sub$Height <- str_replace_all(fifa.df.sub$Height, "[cm]", "")
head(fifa.df.sub$Height, 20)
```

Conseguimos trasformar las medidas de metros a centímetros eliminando la coma y aplicando una función que elimina los espacios en blanco iniciales y finales.

```{r}
fifa.df.sub$Height <- trimws(str_replace(fifa.df.sub$Height, "[,]", ""))
head(fifa.df.sub$Height, 20)
```

Como paso de comprobación, vamos a ver si existe alguna medida cuya longitud sea superior a 3 dígitos.

```{r}
(fifa.df.sub[nchar(fifa.df.sub$Height) > 3, c("Height")])
```

Apareciendo los NA que trataremos más adelante, verificando que no existe ninguna observación mayor de 3 dígitos después de la transformación de la variable.

El siguiente paso será transformar la medida a numérico.

```{r}
fifa.df.sub$Height <- as.numeric(fifa.df.sub$Height)
str(fifa.df.sub$Height)
```

Por último, acabaremos de ajustar aquellas observaciones que originalmente carecían de los dos decimales.

```{r}
fifa.df.sub$Height <- ifelse(nchar(fifa.df.sub$Height) == 1, fifa.df.sub$Height*100, ifelse(nchar(fifa.df.sub$Height) == 2, fifa.df.sub$Height*10, fifa.df.sub$Height))

```

Como paso de verificación, vamos a revisar la observación con formato problemático detectada anteriormente.

```{r}
fifa.df.sub[29, c("Name", "Height")]
```

## 3.3 Weight

La última variable numérica muestra el peso de los jugadores y debe de estar **expresada en kg,** **sin decimales**. Los pasos son similares a la variable Height. Esta vez, vamos a realizar la transformación haciendo uso de pipes para concatenar pasos.

```{r}
str(fifa.df.sub$Weight)
```

De la observación de los primeros registro, podemos ver que la variable se encuentra en formato de string, y que contiene la unidad de medida kg o gramos. Algunos valores están expresados con tres decimales que deberemos eliminar, truncando la expresión para quedarnos con la parte entera. 

Además, en las observaciones dadas en kg, podemos encontrar que el separador decimal es el punto o bien la coma.

Primeramente vamos a diferenciar las medidas de gramos del resto, para poder operar con ellas posteriormente.

```{r}
  fifa.df.sub <-  fifa.df.sub %>% 
    mutate(Weight_Unit = ifelse(str_detect(Weight, "gr"),"gr",""))
  fifa.df.sub[1:10, c("Weight", "Weight_Unit")]
```

A continuación vamos a realizar los siguientes pasos encadenados:

1.  Eliminación de la unidad y de los separadores decimales en la variable *Weight*.

2.  Eliminación de los espacios en blanco en cada observación de la variable.

3.  Conversión de la variable en Numérica.

4.  Añadir el resultado como paso temporal en una nueva columna "*Weight2*", que nos permitirá poder comparar con la columna original.

```{r}
  fifa.df.sub$Weight2 <-   
    fifa.df.sub$Weight %>% 
    str_replace_all(c(","=".",  "kg"="", "gr"="")) %>% 
    trimws() %>% 
    as.numeric()
```


El siguiente paso es utilizar la columna *Weight_Unit* para convertir los valores de gramos a kilos. Adicionalmente, aprovechamos para quedarnos con la parte entera del resultado.

```{r}
gr_to_kg <- function(value, unit){
  if (is.na(unit)==FALSE) {
    if (unit == "gr") {
      return(trunc(value/1000))
    }
    else{
      return(trunc(value))
    }
  }
  else
  {return(NA)}
}
for(i in 1:nrow(fifa.df.sub)){
  fifa.df.sub[i,"Weight2"] <- gr_to_kg(fifa.df.sub[i,"Weight2"], fifa.df.sub[i,"Weight_Unit"])
}

```

Para finalizar, borramos las columnas que ya no nos sirven.

```{r}
fifa.df.sub <- subset(fifa.df.sub, select = -c(Weight, Weight_Unit))
names(fifa.df.sub)[names(fifa.df.sub) == 'Weight2'] <- 'Weight'
```

Y revisamos el resultado.

```{r message=TRUE}
fifa.df.sub[1:10, c("Name", "Weight")]
```

A modo de comprobación, nos fijamos en los valores extremos de la serie y en el formato que nos devuelve.

```{r}
summary(fifa.df.sub$Weight)[c(1, 6)]
```

# 4. Normalización de los datos caulitativos

En este apartado vamos a inspeccionar y normalizar los datos cualitativos.

## 4.1 Name y Nationality

Si examinamos la variable *Name*, podemos comprobar que algunos de sus valores presentan espacios en blanco. Además de no tener una uniformidad con respecto al uso de mayúsculas, tal y como podemos ver a continuación.

```{r}
filas <- c(314, 973, 998, 794)
fifa.df.sub[filas, c("Name", "Nationality")]
```

Aplicamos la limpieza y normalización al campo *Name* y al *Nacionality*, verificando el resultado.

```{r}
fifa.df.sub$Name <- fifa.df.sub$Name %>% trimws() %>% str_to_title()
fifa.df.sub$Nationality <- fifa.df.sub$Nationality %>% trimws() %>% str_to_title()
fifa.df.sub[filas, c("Name", "Nationality")]
```

## 4.2 Preffered_Foot

La variable preffered_foot contiene dos identificadores numéricos que tienen la siguiente correspondencia:

-   1 -\> Left

-   2 -\> Right

```{r}
str(fifa.df.sub$Preffered_Foot)
```

Vamos a realizar una transformación de la variable [a tipo factor]{.ul} con los atributos descritos.

```{r}
fifa.df.sub$Preffered_Foot <- factor(fifa.df.sub$Preffered_Foot)
levels(fifa.df.sub$Preffered_Foot) <- c("Left", "Right")
str(fifa.df.sub$Preffered_Foot)
```

## 4.3 Work_Rate

Siguiendo la línea de este estudio, primeramente vamos a examinar la variable *Work_Rate*. Como se puede observar a continuación, muestra dos valores de tipo string, el primer valor como la valoración cualitativa en ataque y el segundo en defensa.

```{r}
unique(fifa.df.sub$Work_Rate)
```

De la observación de los valores que presenta la variable, podemos ver que no hay uniformidad entre ellos, presentando abreviaturas, como por ejemplo Hig y Med para High y Medium.

```{r}
fifa.df.sub[fifa.df.sub$Work_Rate == 'Med / Med', 'Work_Rate'] = 'Medium / Medium'
fifa.df.sub[fifa.df.sub$Work_Rate == 'Hig / Med', 'Work_Rate'] = 'High / Medium'

```

El siguiente paso será transformar la variable a factor.

```{r}
fifa.df.sub$Work_Rate = factor(fifa.df.sub$Work_Rate)
levels(fifa.df.sub$Work_Rate)
```
Encontrando las [9 posibles combinaciones válidas para esta variable]{.ul}.

# 5 Posibles inconsistencias y variables tipo fecha

En el quinto apartado vamos a tratar las variables de tipo fecha, transformándolas a este tipo cuando no lo estén. Es importante notar que las fechas vienen configuradas con el formato mes/día/año.

## 5.1 Club_Joining

La variable *Club_Joining* tiene que estar dentro del rango: 1990 a 2017. Al examinarla, vemos que el tipo de datos es literal.

```{r}
str(fifa.df.sub$Club_Joining)
```

Así que el siguiente paso será transformar su tipo a fecha, tal y como le corresponde.

```{r}
fifa.df.sub$Club_Joining = mdy( fifa.df.sub[, "Club_Joining"])
str(fifa.df.sub[, "Club_Joining"])
```

Una vez convertida la variable, vamos a comprobar si existen fechas fuera de rango

```{r}
summary(fifa.df.sub[year(fifa.df.sub$Club_Joining) <= 1990 || year(fifa.df.sub$Club_Joining) > 2017, "Club_Joining"])
```

Viendo que todas las fechas se encuentran dentro del rango.

## 5.2 Contract_Expiry \>= Club_Joining?

En este apartado, vamos a mirar si se cumple **la regla de integridad** de que no exista ningún jugador cuyo año de expiración de contrato sea inferior al año de inicio del contrato. Lo ideal hubiera sido poder comparar a nivel de fechas, pero en nuestro caso, la variable *Contract_Expiry* **sólo recoge el año**. De todas maneras, teniendo en cuenta que los jugadores son renovados por temporadas, la afectación al no bajar a máxima granularidad no tiene que ser importante.

```{r}
nrow(na.omit(fifa.df.sub[fifa.df.sub$Contract_Expiry < year(fifa.df.sub$Club_Joining), c("Club_Joining", "Contract_Expiry")]))
```

No encontrándose ningún caso. Lo que si que encontramos es un registro con valor desconocido que sería interesante tratar.

```{r}
fifa.df.sub[is.na(fifa.df.sub$Contract_Expiry)== TRUE, ]
```
En este caso concreto, y viendo que tampoco tenemos la fecha de contrato del club, se puede eliminar el registro o inferir la media de la serie.

## 5.3 Revisar si la edad corresponde a la fecha de nacimiento

Vamos a verificar que la variable *Age*, a fecha 01/01/2017 tiene su correspondencia con la que incorpora el registro en la variable *Birth_Date*. Primero de todo, si examinamos esta última variable, encontramos que tenemos que realizar una transformación de tipo de datos de literal a fecha (un casting de la variable).

```{r}
str(fifa.df.sub$Birth_Date)
fifa.df.sub$Birth_Date <- mdy(fifa.df.sub$Birth_Date)

str(fifa.df.sub$Birth_Date)
```

Ahora que ya tenemos la variable en su formato correcto, podemos calcular la edad**en el primer día del año 2017** y compararla con la almacenada.

```{r}
current_date <- ymd(20170101)
fifa.df.sub<- fifa.df.sub %>% 
  mutate(Calculated_Age = trunc(as.numeric(as.period(interval(fifa.df.sub$Birth_Date, current_date)), unit="year"), "year"))
fifa.df.sub[1:10, c("Name", "Birth_Date", "Age", "Calculated_Age")]
```

En los casos en los que no tenemos año de nacimiento, la fórmula no ha podido calcular la diferencia de tiempo. En otros casos, como por ejemplo el primer registro, vemos que la edad calculada difiere de la edad almacenada en 1 dígito. Este resultado podría ser debido a si emplearon redondeo en el cálculo de la edad (nosotros hemos truncado la cifra a su parte entrena), o si utilizaron una fecha diferente al primero de enero del 2017. En todo caso, vamos a revisar cuantas observaciones se ven afectadas por la diferencia entre la edad calculada y la almacenada.

```{r}
head(na.omit(fifa.df.sub[fifa.df.sub$Calculated_Age!=fifa.df.sub$Age, c("Name", "Birth_Date", "Age", "Calculated_Age")]))
paste("Número de registros con Edad diferente: ", nrow(na.omit(fifa.df.sub[fifa.df.sub$Calculated_Age!=fifa.df.sub$Age, c("Name", "Age", "Calculated_Age")])))
```

Vamos a actualizar la variable *Age* con los valores calculados.

```{r}
real_age <- function(age1, age2){
  if (age1 != age2 & !is.na(age2)) {
    return(age2)
  } else {
    return(age1)
  }
}
for(i in 1:nrow(fifa.df.sub)){
  fifa.df.sub[i,"Age"] <- real_age(fifa.df.sub[i,"Age"], fifa.df.sub[i,"Calculated_Age"])
}
fifa.df.sub[1:10, c("Name", "Birth_Date", "Age", "Calculated_Age")]
```

Ya hemos conseguido actualizar la variable *Age* con los valores calculados para aquellos casos en los que eran diferentes y existían valores. Es el momento de borrar la columna temporal *Calculated_Age* que nos ha servido para el cálculo.

```{r}
fifa.df.sub <- select(fifa.df.sub, -Calculated_Age)
```

# 6 Estudio de valores atípicos

En este capítulo del análisis exploratorio, vamos a revisar si existen valores atípicos para la variables *Height* y *Weight*.

## 6.1 Valores atípicos de *Height*
```{r}
boxplot(fifa.df.sub$Height, main = "Height", color= "gray")
```

El bloxplot de la variable *Height*, nos marca valores fuera del 1.5 veces el rango intercuartílico. La pregunta que nos tendríamos que realizar, es si estos datos extremos los podemos considerar *outliers* o no. Examinemos la lista de valores.

```{r}
boxplot.stats(fifa.df.sub$Height)$out %>% unique() %>% sort()
summary(fifa.df.sub$Height)
```

Aunque la media es una medida de tendencia central que se ve fuertemente influenciada por los valores extremos, en este caso, [vemos que media y mediana prácticamente coinciden]{.ul}. Por esa razón, no parece indicado la eliminación de los valores extremos encontrados por el bloxplot.

## 6.2 Valores atípicos de *Weight*

El paso siguiente será repetir la búsqueda de outliers para la variable Weight

```{r}
boxplot(fifa.df.sub$Weight, main = "Weight", color= "gray")
```
Como pasaba en la variable anterior, media y mediana se encuentran centradas, por lo que podemos afirmar que los valores extremos no influencian en exceso desvirtuando la tendencia de la serie.

Vamos a ver los valores extremos en formato numérico.

```{r}
boxplot.stats(fifa.df.sub$Weight)$out %>% unique() %>% sort()
summary(fifa.df.sub$Weight)
```

En este caso, los valores extremos son perfectamente válidos y acordes con pesos de la vida real, y la desviación entre media y mediana es también pequeño (menos de un 0.4 %), **no justificándose la eliminación** de los valores extremos de la serie numérica.

# 7. Imputación de valores

En este capítulo vamos a inferir los valores desconocidos de las variables *Height* y *Weight*, a partir del valor conocido de una de ellas utilizando para ello una regresión lineal.

## 7.1. Inferir Height a partir de Weight

Examinemos primero los valores desconocidos de la serie.

```{r}
gamer_na_height <- fifa.df.sub[is.na(fifa.df.sub$Height) == TRUE, 'ID']
fifa.df.sub[gamer_na_height, c("Name", "Height")]
```

Generaremos el modelo de regresión lineal utilizando la variable peso como variable conocida para inferir la altura.

```{r}
fmla <- fifa.df.sub$Height ~ fifa.df.sub$Weight
lineal.model <- lm(fmla, data = fifa.df.sub)
lineal.model
```

A modo de prueba podemos observar que el coeficiente es positivo (0.73), lo que indicaría que peso y altura se relacionan directamente, a más peso, más altura, aunque en la vida real encontramos casos en los que esta relación directa no siempre se cumple, son casos particulares, y como regla general esta relación es perfectamente válida.

La métrica de $$R^2$$, cuyo rango va de 0 a 1, nos determinará cuanto de bien se ajusta nuestro modelo a los datos. La bonanza del modelo nos lo determina la proximidad a 1 del resultado. En este caso es ligeramente superior a 0.5, lo cual nos indica un pobre ajuste de nuestro modelo.

```{r}
summary(lineal.model)$r.squared
```

Realizamos la predicción, y examinaremos el modelo gráficamente para ver si la predicción se ajusta a los datos que ya tenemos. Cuanto menos disperso estén los puntos respecto de la recta, mejor será el ajuste de nuestra regresión.

```{r}
fifa.df.sub$pred.Height <- predict(lineal.model, fifa.df.sub)

ggplot(fifa.df.sub, aes(x = pred.Height, y = Height)) + 
  geom_point() +
  geom_abline(color= "darkblue") + 
  ggtitle("Predicción del Peso del jugador")
```

Examinamos el resultado de la predicción para los jugadores con valores de altura desconocidos. [Hemos de aplicar el mismo formato numérico] {.ul}, sin decimales, que ya aplicamos en su momento a los valores originales.

```{r}
fifa.df.sub[is.na(fifa.df.sub$Height), c("Name", "Height", "pred.Height")]
```

Por último, vamos a actualizar la variable de altura con los nuevos valores inferidos.

```{r}
fifa.df.sub[is.na(fifa.df.sub$Height), "Height"] <- trunc(fifa.df.sub[is.na(fifa.df.sub$Height), "pred.Height"])
paste("Número de filas con altura desconocida: ", nrow(fifa.df.sub[is.na(fifa.df.sub$Height),]))
```

Mostramos los valores resultantes tras finalizar el proceso.

```{r}
fifa.df.sub[gamer_na_height, c("Name", "Height")]
```

## 7.2. Inferir Weight a partir de Height

A continuación, realizaremos la predicción del peso a partir de la altura del jugador, siguiendo el esquema utilizado en el apartado anterior. Previamente, vamos a registrar las observaciones afectadas.

```{r}
gamer_na_weight <- fifa.df.sub[is.na(fifa.df.sub$Weight) == TRUE, 'ID']
fifa.df.sub[gamer_na_weight, c("Name", "Weight")]
```

```{r}
fmla <- fifa.df.sub$Weight ~ fifa.df.sub$Height
lineal.model <- lm(fmla, data = fifa.df.sub)
summary(lineal.model)$r.squared
```

Se mantiene el R cuadrado. A continuación, vamos a predecir el peso a partir de la altura.

```{r}
fifa.df.sub$pred.Weight <- predict(lineal.model, fifa.df.sub)
fifa.df.sub[is.na(fifa.df.sub$Weight), c("Name", "Weight", "pred.Weight")]
```

El siguiente paso que daremos será actualizar la variable del peso del jugador que presenta valores desconocidos con las predicciones encontradas. Estas predicciones se tienen que adaptar al formato de los datos de origen. Para ello, truncaremos el valor quedándonos con la parte entera.

```{r}
fifa.df.sub[is.na(fifa.df.sub$Weight), "Weight"] <- trunc(fifa.df.sub[is.na(fifa.df.sub$Weight), "pred.Weight"])
fifa.df.sub[gamer_na_weight, c("Name", "Weight")]
```

Como última comprobación, miraremos que las dos variables tratadas, Height y Weight, están libres de valores desconocidos, para finalmente, eliminar del modelo de datos las dos variables de predicción utilizadas y que ya no aportan nada al modelo.

```{r}
paste("Número de filas con peso desconocido: ", nrow(fifa.df.sub[is.na(fifa.df.sub$Weight),]))
paste("Número de filas con altura desconocida: ", nrow(fifa.df.sub[is.na(fifa.df.sub$Height),]))
fifa.df.sub[, c("pred.Weight", "pred.Height")] <- NULL
```

## 7.3 Contract_Expiry

La variable **Contract_Expiry** cuenta con un valor desconocido, que nos obliga a tratarlo para poder realizar el estudio. Tenemos varias opciones para ello:
- 1. Podríamos optar por eliminar el registro, o no tenerlo en cuenta para este estudio dado que corresponde a una sola observación entre 17588, pero estaríamos perdiendo información relevante de este jugador. 
- 2. Podríamos imputar el valor más repetido de la serie, pero podríamos incurrir en un sesgo.

- 3. Considero más práctico inferir la media de la población, asumiendo el riesgo de introducir un dato por criterios estadísticos, que no se corresponderá con la realidad (sesgo).

```{r}
fifa.df.sub[is.na(fifa.df.sub$Contract_Expiry)== TRUE, "Contract_Expiry"] = 
round(mean(fifa.df.sub[is.na(fifa.df.sub$Contract_Expiry)== FALSE, "Contract_Expiry"] ),0)
```

# 8. Estudio descriptivo de las variables cuantitativas

En este capítulo, vamos a realizar el estudio de las variables cuantitativas visualizando sus medidas de tendencia centrales.


```{r}
col_names <- c('Contract_Expiry', 'Rating', 'Height', 'Age', 'Weight')
col_names
```

Montaremos una tabla con las medidas de tendencia central y de dispersión.

```{r}
quantitative_study <- function(df, col_names) {
  media <- as.data.frame(lapply(df[, col_names], mean)) %>% 
    round(digits = 2)  %>% mutate(estimator=c("media")) 
  
  mediana <- as.data.frame(lapply(df[, col_names], median)) %>% 
    round(digits = 2)  %>% mutate(estimator=c("mediana"))
  
  media_rec <- as.data.frame(lapply(df[, col_names], mean, trim=0.05)) %>% 
    round(digits = 2)  %>% mutate(estimator=c("media recortada"))
  
  winsor_media <- as.data.frame(lapply(df[, col_names], winsor.mean)) %>% 
    round(digits = 2)  %>% mutate(estimator=c("winsor_media"))
  
  desv_est <- as.data.frame(lapply(df[, col_names], sd)) %>% 
    round(digits = 2)  %>% mutate(estimator=c("desviación estándar"))
  
  RIC <- as.data.frame(lapply(df[, col_names], IQR)) %>% 
    round(digits = 2)  %>% mutate(estimator=c("RIC"))
  
  DAM <- as.data.frame(lapply(df[, col_names], mad)) %>% 
    round(digits = 2)  %>%  mutate(estimator=c("DAM"))
  
  df_out <- merge(media, mediana, all=TRUE)
  df_out <- merge(df_out, media_rec, all=TRUE)
  df_out <- merge(df_out, winsor_media, all=TRUE)
  df_out <- merge(df_out, desv_est, all=TRUE)
  df_out <- merge(df_out, RIC, all=TRUE)
  df_out <- merge(df_out, DAM, all=TRUE)
  return(df_out)
}
  
print(quantitative_study(fifa.df.sub, col_names))
```

Si tomamos como "baseline" **la mediana**, al ser una medida de tendencia central robusta, podemos compararla con el resto de medidas de tendencia. A priori, podríamos pensar que como **la media** es una medida de tendencia central que se ve influida por los extremos, éstos están escorando ligeramente la tendencia alejándola del centro de la serie. No obstante, si comparamos con **la media recortada** (también llamada media truncada), en la que se han eliminado **un 5% de los valores extremos**, vemos que efectivamente los la serie tiene un ligero desvío hacia la derecha (hacia un mayor valor). Esto se puede acabar de confirmar con **la media winsorizada**, medida robusta que nos muestra unos valores similares a los anteriores.

En cuanto a **la desviación**, se obtiene una menor dispersión de los valores utilizando como base para su cálculo la media que no la mediana. Al haber visto que los extremos no tienen una gran influencia en la serie, podríamos tomar como buena la medida de **la desviación estándar**, aunque la **DAM** sea una medida de dispersión más robusta.

# 9. Análisis de Componentes Principales (ACP)

En este capítulo vamos a realizar un análisis de componentes principales (PCA en inglés) sobre las variables "**Rating**", "**Height**", "**Weight**" y "**Age**". Aunque primeramente vamos a mirar la matriz de correlaciones, dado que para que la ACP sea efectiva, tiene que existir un alto grado de correlación entre las variables.

```{r}
cor(fifa.df.sub[, col_names])
```

Las dos únicas variables **correlacionadas** directamente son Altura y Peso.

Antes de lanzar el análisis de PCA hemos de pensar que la matriz de datos está formada por [variables con diferentes magnitudes y rangos]{.ul}. Por ello, vamos a utilizar la matriz de correlaciones que transformará las variables en estandarizadas de media cero y desviación típica uno.

Lancemos el análisis y estudiemos su resultado.

```{r}
col_names <- c( "Rating", "Height", "Weight", "Age")
fifa.pca <- prcomp(na.omit(fifa.df.sub[, col_names]), center = TRUE, scale. = TRUE)
summary(fifa.pca)
```
Vemos que la proporción de varianza no proporciona buenos resultados. Como hemos visto anteriormente, la correlación entre las variables era escasa. No obstante, fijándonos en la varianza acumulada podemos observar que con los dos primeros componentes podemos representar el 80,8% del modelo.

Veamos los vectores propios.

```{r}
fifa.pca$rotation
```
Para saber que componentes utilizar, vamos a verlo visualmente.

```{r}
fifa_biplot_chart <- function(x, y){
  ggbiplot(fifa.pca, choices = x:y, obs.scale = 1, var.scale = 1, 
           pc.biplot =TRUE, labels.size = 3, var.axes = TRUE, 
           varname.size=5, alpha = 0.05) 

}

par(mfrow= c(2,2))

for(i in 1:3) {
  print(fifa_biplot_chart(i,i+1))
  }

```
Del examen del primer gráfico, que representa a las dos primeras componentes, podemos observar lo siguiente:

- Con la primera componente se explicaría el 47,4% de la varianza, siendo la que más contribuye al modelo. 

- Podemos observar también, una proximidad entre el par de variables Weight y Height, por un lado, y **Rating** y **Age** por el otro. Una mayor proximidad indica un alto grado de correlación entre las variables, algo que ya habíamos visto al examinar la matriz de correlación. 

- La longitud de las flechas indican la importancia que tienen las variables originales en las componentes.En todos los gráficos vemos que la longitud es similar, no destacando ninguna variable sobre el resto.

Por último, encontramos [un punto residual fuera de la nube de puntos]{.ul}, que se repite en los tres gráficos de componentes. Este punto, podría ser clasificado como **outlier** y sacado fuera del modelo de datos, aunque para ello se tendría que valorar su valor respecto al contexto del análisis, cosa que veremos a continuación. 

Veamos los valores de las variables para este punto. Primero encontramos la proyección para este punto, fijándonos que es el valor mínimo que toma PC1.

```{r}
projection <- fifa.pca$x[fifa.pca$x[, 1] == min((fifa.pca$x)[, 1]), ]
print(projection)

```
Encontramos la posición del valor mínimo encontrado.
```{r}
pos <-min(which(fifa.pca$x[, 1] == projection[1]))
```

A continuación vamos a calcular la matriz original de valores a partir de la proyección y de los vectores propios, teniendo en cuenta que los valores están centrados y reescalados.

```{r}
reverse_pca <- t(t(fifa.pca$x %*% t(fifa.pca$rotation))* fifa.pca$scale + fifa.pca$center)
reverse_pca[pos,]
```
Podemos ver que es un punto en el que tanto las variables peso como la altura muestran valores anormalmente altos, pero perfectamente posibles. Así que podemos considerar que aunque este punto corresponde a un extremo de la serie, [no podemos considerarlo como outlier]{.ul}.


# Archivo final

# Conclusión

A lo largo de esta actividad se ha puesto en práctica las técnicas de verificación y normalización de variables. Además, se ha buscado inconsistencia en los datos y se ha enriquecido la información tratando los valores perdido. 

Se ha dedicado un capítulo a la observación de los valores extremos, detectándolos y eligiendo la mejor opción según el contexto de los datos.

Se han calculado algunas medidas de tendencia central y dispersión, enfrentándolas entre ellas para obtener un avance del análisis descriptivo.

Por último, se ha realizado un análisis de componentes principales con algunas de las variables cuantitativas, con el resultado de que no se ha encontrado una medida de varianza suficientemente alta como para determinar la eliminación de algún componente principal.
