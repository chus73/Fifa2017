---
title: "Preprocesado de datos del Fifa 2017"
author: "Jesús González"
date: "8/3/2021"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    number_sections: true
    theme: paper
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#install.packages("tidyverse")
#library(tidyverse)
library(stringr)
library(dplyr)
library(lubridate)
library(ggplot2)
```

# Carga del archivo

```{r}
fifa.df <- read.csv(file="fifa_raw.csv", encoding = "UTF-8")
paste0("Número de observaciones: ", nrow(fifa.df),". Número de variables: ", ncol(fifa.df))
```

Realizamos un subset con las variables escogidas para el estudio.

```{r}
col_names <- c("ID", "Name", "Nationality", "Club_Joining", "Contract_Expiry", "Rating", "Height", "Weight", "Preffered_Foot", "Birth_Date", "Age", "Work_Rate")
fifa.df.sub <- fifa.df[, col_names]
paste0("Número de observaciones: ", nrow(fifa.df.sub),". Número de variables: ", ncol(fifa.df.sub))
```

Se ha pasado de 54 variables a 11, manteniendo el número de observaciones. A continuación se muestran las 5 primeras observaciones de la muestra.

```{r message=TRUE}
head(fifa.df.sub,5)
```

Vamos a examinar cada una de las variables.

```{r}
summary(fifa.df.sub)
```

De la observación de las características de las variables y de las cinco primera observaciones podemos ver los siguiente:

1.  Contract_Expiry: Presenta como mínimo un valor NA.

2.  Preffered_Foot: Contiene valores 1,2 que se tendrán que traducir en Left y Right respectivamente.

3.  En las variables numéricas, a excepción de la anterior en la que carece de sentido, la media y la mediana tienen valores similares, que indica poca presencia de Outliers.

4.  Las variables Height and Weight presentan valores NA que tendrán que ser tratados.

# Verificar la duplicación de registros

En esta sección se realizará la comprobación de existencia de observaciones duplicadas en la muestra. Para ello, primeramente vamos a comprobar si el campo "ID" se encuentra duplicado mediante la comparación de la longitud del vector antes y después de aplicar la función de eliminación de duplicados.

```{r}
if (length(fifa.df.sub$ID) == length(unique(fifa.df.sub$ID))) {
  print("No hay diferencias en el ID")} else {print("Existen diferencias en el ID")}
```

No obstante, esto no nos garantiza que no existan jugadores duplicados, dado que el ID puede ser generado con un autonumérico en Base de Datos. Como doble comprobación, utilizaremos la variable con el nombre del jugador, como criterio extra en la búsqueda de duplicados.

```{r}
if (length(unique(fifa.df.sub$Name)) != nrow(fifa.df.sub)){
  paste("Tenemos", (nrow(fifa.df.sub) - length(unique(fifa.df.sub$Name))), "posibles registros duplicados.")
}
```

Vamos a mostrar algunos de los duplicados.

```{r}
head(fifa.df.sub[duplicated(fifa.df.sub$Name),], 10)

```

Si escogemos uno aleatóriamente, por ejemplo el jugador "Fernando".

```{r}
fifa.df.sub[fifa.df.sub$Name == "Fernando",]
```

Podemos ver comparando el resto de variables que muestra a tres jugadores diferentes. Como es lógico pensar que Fernando es un nombre común, vamos a probar con otro como "Lisandro López".

```{r}
fifa.df.sub[fifa.df.sub$Name == "Lisandro López",]
```

Viendo por el resultado, que también estamos hablando de dos jugadores con variables diferentes.

Tras lo visto, y viendo que la calidad del dato es bastante pobre, no podemos confirmar que [existan observaciones duplicadas en la muestra]{.ul}.

# Normalización de los datos cuantitativos

En este apartado se va a realizar la normalización de la variables cuantitativas con objeto de uniformizar su formato.

## Rating

La variable numérica *rating*, incluye la valoración del jugador dentro de un rango entre 0 y 100. Un vistazo a sus valores máximos y mínimo nos puede mostrar si están dentro del rango esperado.

```{r}
str(fifa.df.sub$Rating)
summary(fifa.df.sub$Rating)[c(1,6)]
```

## Height

La variable que muestra la altura de los jugadores, height, debe de estar en cm con un formato de 3 dígitos sin decimales.

```{r}
head(fifa.df.sub$Height,20)
```

Además, tenemos que tener especial cuidado debido a que las medidas en metros, no cumplen con una homegeneidad de formato, como se puede ver en el siguiente registro

```{r}
fifa.df[29,c("Name", "Height")]
```

Vemos que hay observaciones con medidas en centímetros, y otras en metros. Eliminaremos la unidad que aparece al final

```{r}
fifa.df.sub$Height <- str_replace_all(fifa.df.sub$Height, "[cm]", "")
head(fifa.df.sub$Height, 20)
```

Conseguimos trasformar las medidas de metros a centímetros eliminando la coma y aplicando una función que elimina los espacios en blanco iniciales y finales.

```{r}
fifa.df.sub$Height <- trimws(str_replace(fifa.df.sub$Height, "[,]", ""))
head(fifa.df.sub$Height, 20)
```

Como paso de comprobación, vamos a ver si existe alguna medida cuya longitud sea superior a 3 dígitos.

```{r}
tail(fifa.df.sub[nchar(fifa.df.sub$Height)>3, c("Height")])
```

Apareciendo los NA que trataremos más adelante.

El siguiente paso será transformar la medida a numérico.

```{r}
fifa.df.sub$Height <- as.numeric(fifa.df.sub$Height)
str(fifa.df.sub$Height)
```

Por último, acabaremos de ajustar aquellas observaciones que originalmente carecían de los dos decimales.

```{r}
fifa.df.sub$Height <- ifelse(nchar(fifa.df.sub$Height) == 1, fifa.df.sub$Height*100, ifelse(nchar(fifa.df.sub$Height) == 2, fifa.df.sub$Height*10, fifa.df.sub$Height))
fifa.df.sub[29, c("Name", "Height")]
```

## Weight

La última variable numérica muestra el peso de los jugadores y debe de estar **expresada en kg,** **sin decimales**. Los pasos son similares a la variable Height. Esta vez, vamos a realizar la transformación haciendo uso de pipes para concatenar pasos.

```{r}
str(fifa.df.sub$Weight)
```

De la observación de los primeros registro, podemos ver que la variable se encuentra en formato de string, y que contiene la unidad de medida kg o gramos. Los valores están expresados con tres decimales que deberemos de reducir a dos. Además, en las observaciones dadas en kg, podemos encontrar que el separador decimal es el punto o bien la coma.

Primeramente vamos a diferenciar las medidas de gramos del resto, para poder operar con ellas posteriormente.

```{r}
  fifa.df.sub <-  fifa.df.sub %>% 
    mutate(Weight_Unit = ifelse(str_detect(Weight, "gr"),"gr",""))
  fifa.df.sub[1:10, c("Weight", "Weight_Unit")]
```

A continuación vamos a realizar los siguientes pasos encadenados:

1.  Eliminación de la unidad en la variable Weight.

2.  Eliminación de los espacios en blanco en cada observación de la variable.

3.  Sustitución de las comas por los puntos como separadores decimales.

4.  Conversión de la variable en Numérica.

5.  Añadir el resultado en una nueva columna, "Weight2", que nos permitirá poder comparar con la columna original.

```{r}
  fifa.df.sub$Weight2 <-   
    fifa.df.sub$Weight %>% 
    str_replace_all(c(","=".",  "kg"="", "gr"="")) %>% 
    trimws() %>% 
    as.numeric()
```

```{r message=TRUE}
fifa.df.sub[1:10, c("Weight", "Weight_Unit", "Weight2")]
```

El siguiente paso es utilizar la columna Weight_Unit para convertir los valores en gramos a kilos.

```{r}
gr_to_kg <- function(value, unit){
  if (is.na(unit)==FALSE) {
    if (unit == "gr") {
      return(trunc(value/1000))
    }
    else{
      return(trunc(value))
    }
  }
  else
  {return(NA)}
}
for(i in 1:nrow(fifa.df.sub)){
  fifa.df.sub[i,"Weight2"] <- gr_to_kg(fifa.df.sub[i,"Weight2"], fifa.df.sub[i,"Weight_Unit"])
}

```

Para finalizar, borramos las columnas que ya no nos sirven.

A modo de comprobación, nos fijamos en los valores extremos de la serie y en el formato que nos devuelve.

```{r}
fifa.df.sub <- subset(fifa.df.sub, select = -c(Weight, Weight_Unit))
fifa.df.sub <- fifa.df.sub %>% rename(Weight = Weight2)
summary(fifa.df.sub$Weight)
```

# Normalización de los datos caulitativos

## Name y Nationality

Si examinamos la variable Name, podemos comprobar que algunos de sus valores presentan espacios en blanco. Además de no tener una uniformidad con respecto al uso de mayúsculas, tal y como podemos ver a continuación.

```{r}
filas <- c(314, 973, 998, 794)
fifa.df.sub[filas, "Name"]
```

Aplicamos la limpieza y normalización al campo Name y al Nacionality.

```{r}
fifa.df.sub$Name <- fifa.df.sub$Name %>% trimws() %>% str_to_title()
fifa.df.sub$Nationality <- fifa.df.sub$Nationality %>% trimws() %>% str_to_title()
fifa.df.sub[filas, c("Name", "Nationality")]
```

## Preffered_Foot

La variable preffered_foot contiene dos identificadores numéricos que tienen la siguiente correspondencia:

-   1 -\> Left

-   2 -\> Right

Vamos a realizar una transformación de la variable a tipo factor con los atributos descritos.

```{r}
str(fifa.df.sub$Preffered_Foot)
fifa.df.sub$Preffered_Foot <- factor(fifa.df.sub$Preffered_Foot)
levels(fifa.df.sub$Preffered_Foot) <- c("Left", "Right")
str(fifa.df.sub$Preffered_Foot)
```

## Work_Rate

Examinamos la variable Work_Rate. Como se puede observar a continuación, muestra dos valores de tipo string, el primer valor como la valoración cualitativa en ataque y el segundo en defensa.

```{r}
unique(fifa.df.sub$Work_Rate)
```

De la observación de los valores que presenta la variable, podemos ver que no hay uniformidad entre ellos, presentando abreviaturas, como por ejemplo Hig y Med para High y Medium.

```{r}
fifa.df.sub[fifa.df.sub$Work_Rate == 'Med / Med', 'Work_Rate'] = 'Medium / Medium'
fifa.df.sub[fifa.df.sub$Work_Rate == 'Hig / Med', 'Work_Rate'] = 'High / Medium'
summary(fifa.df.sub$Work_Rate)
```

Una vez obtenidas las nueve combinaciones válidas, podemos transformar la variable a factor.

```{r}
fifa.df.sub$Work_Rate = factor(fifa.df.sub$Work_Rate)
str(fifa.df.sub$Work_Rate)
```

# Posibles inconsistencias y variables tipo fecha

## Club_Joining

La variable Club_Joining tiene que estar dentro del rango: 1990 a 2017. Al examinarla, vemos que el tipo de datos es literal.

```{r}
str(fifa.df.sub$Club_Joining)


```

Así que el siguiente paso será transformar su tipo a fecha, tal y como le corresponde.

```{r}
str(fifa.df.sub[, "Club_Joining"])
fifa.df.sub$Club_Joining = dmy( fifa.df.sub[, "Club_Joining"])
str(fifa.df.sub[, "Club_Joining"])
```

Una vez convertida la variable, vamos a comprobar si existen fechas fuera de rango

```{r}
summary(fifa.df.sub[year(fifa.df.sub$Club_Joining) <= 1990 || year(fifa.df.sub$Club_Joining) > 2017, "Club_Joining"])
```

Viendo que todas las fechas se encuentran dentro del rango.

## Contract_Expiry \>= Club_Joining?

En este apartado, vamos a mirar si se cumple **la regla de integridad** de que no exista ningún jugador cuyo año de expiración de contrato sea inferior al año de inicio del contrato. Lo ideal hubiera sido poder comparar a nivel de fechas, pero en nuestro caso, la variable *Contract_Expiry* **sólo recoge el año**. De todas maneras, teniendo en cuenta que los jugadores son renovados por temporadas, la afectación de no bajar a máxima granularidad no tiene que ser importante.

```{r}
nrow(na.omit(fifa.df.sub[fifa.df.sub$Contract_Expiry < year(fifa.df.sub$Club_Joining), c("Club_Joining", "Contract_Expiry")]))
```

No encontrándose ningún caso.

## Revisar si la edad corresponde a la fecha de nacimiento

Vamos a verificar que la variable Age, a fecha 01/01/2017 tiene su correspondencia con la que incorpora el registro en la variable Birth_Date. Primero de todo, si examinamos esta última variable, encontramos que tenemos que realizar una transformación de tipo de datos de litaral a fecha (casting).

```{r}
str(fifa.df.sub$Birth_Date)
fifa.df.sub$Birth_Date <- dmy(fifa.df.sub$Birth_Date)

str(fifa.df.sub$Birth_Date)
```

Ahora que ya tenemos la variable en su formato correcto, podemos calcular la edad en el primer día del año 2017 y compararla con la almacenada.

```{r}
current_date <- ymd(20170101)
fifa.df.sub<- fifa.df.sub %>% 
  mutate(Calculated_Age = trunc(as.numeric(as.period(interval(fifa.df.sub$Birth_Date, current_date)), unit="year"), "year"))
fifa.df.sub[1:10, c("Name", "Birth_Date", "Age", "Calculated_Age")]
```

En los casos en los que no tenemos año de nacimiento, la fórmula no ha podido calcular la diferencia de tiempo. En otros casos, como por ejemplo el primer registro, vemos que la edad calculada difiere de la edad almacenada en 1 dígito. Este resultado podría ser debido a si emplearon redondeo en el cálculo de la edad (nosotros hemos truncado la cifra a su parte entrena), o si utilizaron una fecha diferente al primero de enero del 2017. En todo caso, vamos a revisar cuantas observaciones se ven afectadas por la diferencia entre la edad calculada y la almacenada.

```{r}
head(na.omit(fifa.df.sub[fifa.df.sub$Calculated_Age!=fifa.df.sub$Age, c("Name", "Birth_Date", "Age", "Calculated_Age")]))
paste("Número de registros con Edad diferente: ", nrow(na.omit(fifa.df.sub[fifa.df.sub$Calculated_Age!=fifa.df.sub$Age, c("Name", "Age", "Calculated_Age")])))
```

Vamos a actualizar la variable Age con los valores calculados.

```{r}
fifa.df.sub[1:10, c("Name", "Birth_Date", "Age", "Calculated_Age")]

#fifa.df.sub$Age2 <-fifa.df.sub$Age
#fifa.df.sub[fifa.df.sub$Calculated_Age!=fifa.df.sub$Age & !is.na(fifa.df.sub$Calculated_Age), "Age2"] = fifa.df.sub$Calculated_Age
real_age <- function(age1, age2){
  if (age1 != age2 & !is.na(age2)) {
    return(age2)
  } else {
    return(age1)
  }
}
for(i in 1:nrow(fifa.df.sub)){
  fifa.df.sub[i,"Age"] <- real_age(fifa.df.sub[i,"Age"], fifa.df.sub[i,"Calculated_Age"])
}
fifa.df.sub[1:10, c("Name", "Birth_Date", "Age", "Calculated_Age")]
```

Ya hemos conseguido actualizar la variable Age con los valores calculados para aquellos casos en los que eran diferentes y existían valores. Es el momento de borrar la columna temporal Calculated_Age que nos ha servido para el cálculo.

```{r}
fifa.df.sub <- select(fifa.df.sub, -Calculated_Age)
```

# Valores atípicos

Vamos a revisar si existen valores atípicos para la variables Height.

```{r}
boxplot(fifa.df.sub$Height, main = "Height", color= "gray")
```

Tanto el bloxplot de la variable Height, como de la Weight nos marcan valores fuera del 1.5 veces el rango intercuartílico, que podríamos considerar outliers (!). En concreto, si nos fijamos en la variable Height, podemos ver que corresponden a la siguiente lista.

```{r}
boxplot.stats(fifa.df.sub$Height)$out %>% unique() %>% sort()
summary(fifa.df.sub$Height)
```

Aunque la media es una medida de tendencia central que se ve fuertemente influenciada por los valores extremos, en este caso, vemos que media y mediana prácticamente coinciden. Por esa razón, no parece indicado la eliminación de los valores extremos encontrados por el bloxplot.

El paso siguiente será repetir la búsqueda de outliers para la variable Weight

```{r}
boxplot(fifa.df.sub$Weight, main = "Weight", color= "gray")
```

```{r}
boxplot.stats(fifa.df.sub$Weight)$out %>% unique() %>% sort()
summary(fifa.df.sub$Weight)
```

En este caso, la desviación entre media y mediana es también pequeño (menos de un 0.4 %), **no justificándose la eliminación** de los valores extremos de la serie numérica.

# Imputación de valores

En este capítulo vamos a inferir los valores desconocidos de las variables Height y Weight, a partir del valor conocido de una de ellas utilizando la regresión lineal.

## Inferir Height a partir de Weight

Examinemos primero los valores desconocidos de la serie.

```{r}
fmla <- fifa.df.sub$Height ~ fifa.df.sub$Weight
lineal.model <- lm(fmla, data = fifa.df.sub)
lineal.model
```

A modo de prueba podemos observar que el coeficiente es positivo (0.73), lo que indicaría que peso y altura se relacionan directamente, a más peso, más altura, aunque lo lógica nos dice que esto no siempre se cumple.

La métrica de R\^2, cuyo rango va de 0 a 1, nos determinará cuanto de bien se ajusta nuestro modelo a los datos. La bonanza del modelo nos lo determina la proximidad a 1 del resultado. En este caso es ligeramente superior a 0.5, lo cual nos indica un pobre ajuste.

```{r}
summary(lineal.model)$r.squared
```

Realizamos la predicción, y examinaremos el modelo gráficamente para ver si la predicción se ajusta a los datos que ya tenemos. Cuanto menos disperso estén los puntos respecto de la recta, mejor será el ajuste de nuestra regresión.

```{r}
fifa.df.sub$pred.Height <- predict(lineal.model, fifa.df.sub)

ggplot(fifa.df.sub, aes(x = pred.Height, y = Height)) + 
  geom_point() +
  geom_abline(color= "darkblue") + 
  ggtitle("Predicción del Peso del jugador")
```

Examinamos el resultado de la predicción para los jugadores con valores de altura desconocidos.

```{r}
fifa.df.sub[is.na(fifa.df.sub$Height), c("Name", "Height", "pred.Height")]
```

Por último, vamos a actualizar la variable de altura con los nuevos valores inferidos.

```{r}
fifa.df.sub[is.na(fifa.df.sub$Height), "Height"] <- fifa.df.sub[is.na(fifa.df.sub$Height), "pred.Height"]
paste("Número de filas con altura desconocida: ", nrow(fifa.df.sub[is.na(fifa.df.sub$Height),]))
```

## Inferir Weight a partir de Height

A continuación, realizaremos la predicción del peso a partir de la altura del jugador, siguiendo el esquema utilizado en el apartado anterior.

```{r}
fmla <- fifa.df.sub$Weight ~ fifa.df.sub$Height
lineal.model <- lm(fmla, data = fifa.df.sub)
summary(lineal.model)$r.squared
```

Se mantiene el R cuadrado. A continuación, vamos a predecir el peso a partir de la altura.

```{r}
fifa.df.sub$pred.Weight <- predict(lineal.model, fifa.df.sub)
fifa.df.sub[is.na(fifa.df.sub$Weight), c("Name", "Weight", "pred.Weight")]
```

Por ultimo, vamos a actualizar la variable peso, eliminando los valores desconocidos, y eliminando la variable de predicción.

```{r}
fifa.df.sub[is.na(fifa.df.sub$Weight), "Weight"] <- fifa.df.sub[is.na(fifa.df.sub$Weight), "pred.Weight"]
paste("Número de filas con peso desconocido: ", nrow(fifa.df.sub[is.na(fifa.df.sub$Weight),]))
```

# Estudio descriptivo de las variables cuantitativas

# Análisis de Componentes Principales (ACP)

# Archivo final
